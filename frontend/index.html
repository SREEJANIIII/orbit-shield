<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OrbitShield ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">

  <!-- Set backend endpoints (local for dev). Replace with deployed endpoints before deploying frontend -->
  <script>
    // Local defaults ‚Äî change these to your Render URLs before deploying frontend to Vercel
    window.BACKEND_HTTP = window.BACKEND_HTTP || "http://localhost:8000";
    window.BACKEND_WS   = window.BACKEND_WS   || "ws://localhost:8000";
  </script>

  <!-- Three.js (keeps your existing visualizer) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js"></script>
</head>

<body>
  <nav class="nav">
    <div class="nav-left">
      <div class="logo">üåê <span class="brand">OrbitShield</span></div>
      <div class="nav-title">Real-time 3D Trajectories & Orbital Dashboard</div>
    </div>
    <div class="nav-right">
      <button id="btn-center" class="btn small">Center Earth</button>
      <button id="btn-pause" class="btn small">Pause Stream</button>
    </div>
  </nav>

  <main class="main-grid">
    <!-- left: 3D canvas + overlay -->
    <section class="visual">
      <div id="three-container" class="three-wrap"></div>

      <div class="overlay top-left">
        <div class="stat">Objects: <span id="stat-objects">0</span></div>
        <div class="stat">Active Alerts: <span id="stat-alerts">0</span></div>
        <div class="stat">Last Update: <span id="stat-timestamp">‚Äî</span></div>
      </div>
    </section>

    <!-- right: dashboard -->
    <aside class="panel">
      <div class="panel-header">
        <h3>Live Feed</h3>
        <div class="controls">
          <select id="filter-type" class="select">
            <option value="all">All</option>
            <option value="satellite">Satellites</option>
            <option value="debris">Debris</option>
          </select>
          <input id="search" class="input" placeholder="Search by name or id" />
        </div>
      </div>

      <div class="panel-section">
        <h4>Objects</h4>
        <div id="objects-list" class="list"></div>
      </div>

      <div class="panel-section">
        <h4>Active Alerts</h4>
        <table id="alerts-table" class="table">
          <thead><tr><th>Time</th><th>Pair</th><th>Dist (km)</th><th>Speed (km/s)</th><th>Risk</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="panel-section details" id="details">
        <h4>Selected Object</h4>
        <div id="selected-info">No object selected</div>
        <div class="detail-actions">
          <button id="btn-simulate" class="btn">Simulate Maneuver</button>
          <button id="btn-export" class="btn outline">Export TLE</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Load your main visualizer script (app.js) -->
  <script src="app.js"></script>

  <!-- Dashboard script: connects to /ws/positions and updates UI -->
  <script>
    (function () {
      const WS_PATH = "/ws/positions";
      const HTTP_TOKEN_ENDPOINT = window.BACKEND_HTTP + "/auth/token";
      let ws = null;
      let paused = false;

      const statObjects = document.getElementById('stat-objects');
      const statAlerts = document.getElementById('stat-alerts');
      const statTimestamp = document.getElementById('stat-timestamp');
      const objectsList = document.getElementById('objects-list');
      const alertsTableBody = document.querySelector('#alerts-table tbody');
      const filterType = document.getElementById('filter-type');
      const searchInput = document.getElementById('search');
      const btnPause = document.getElementById('btn-pause');
      const btnCenter = document.getElementById('btn-center');
      const detailsEl = document.getElementById('selected-info');

      let objects = {};   // id -> object
      let alerts = [];    // list of alerts
      let selectedId = null;

      async function fetchToken() {
        try {
          const r = await fetch(HTTP_TOKEN_ENDPOINT, { method: 'POST' });
          if (!r.ok) return "";
          const j = await r.json();
          return j.token || "";
        } catch (e) {
          console.warn("Token fetch failed", e);
          return "";
        }
      }

      async function connectWS() {
        const token = await fetchToken();
        let url;
        try {
          url = new URL((window.BACKEND_WS || '') + WS_PATH);
        } catch {
          // fallback
          url = new URL((window.BACKEND_WS || 'ws://localhost:8000') + WS_PATH);
        }
        if (token) url.searchParams.set('token', token);

        ws = new WebSocket(url.toString());
        ws.addEventListener('open', () => {
          console.log("Dashboard WS connected");
          btnPause.textContent = 'Pause Stream';
          paused = false;
        });
        ws.addEventListener('message', (evt) => {
          if (paused) return;
          try {
            const msg = JSON.parse(evt.data);
            handleMessage(msg);
          } catch (e) {
            // ignore non-JSON or pongs
          }
        });
        ws.addEventListener('close', () => {
          console.log("Dashboard WS closed, reconnecting in 1s");
          setTimeout(connectWS, 1000);
        });
        ws.addEventListener('error', (e) => {
          console.warn("WS error", e);
          ws && ws.close();
        });
      }

      function handleMessage(payload) {
        if (!payload) return;
        // If payload comes in your 'state' shape: timestamp, objects, alerts
        if (payload.timestamp) {
          statTimestamp.textContent = new Date(payload.timestamp).toLocaleTimeString();
        }

        if (Array.isArray(payload.objects)) {
          payload.objects.forEach(o => {
            objects[o.type + "-" + o.id] = o;
          });
          renderObjectsList();
        }

        if (Array.isArray(payload.alerts)) {
          // prepend newest alerts
          payload.alerts.forEach(a => {
            a._ts = new Date().toISOString();
            alerts.unshift(a);
            if (alerts.length > 200) alerts.pop();
          });
          renderAlerts();
        }

        // update stats
        statObjects.textContent = Object.keys(objects).length;
        statAlerts.textContent = alerts.length;
      }

      function renderObjectsList() {
        objectsList.innerHTML = '';
        const q = searchInput.value.trim().toLowerCase();
        const typeFilter = filterType.value;

        const rows = Object.values(objects)
          .filter(o => {
            if (typeFilter !== 'all' && o.type !== typeFilter) return false;
            if (!q) return true;
            return (String(o.id).toLowerCase().includes(q) || (o.name||'').toLowerCase().includes(q));
          })
          .sort((a,b) => (a.type === b.type)? a.id-b.id : (a.type === 'satellite' ? -1 : 1))
          .slice(0,200);

        for (const o of rows) {
          const el = document.createElement('div');
          el.className = 'list-item';
          el.dataset.id = o.type + "-" + o.id;
          el.innerHTML = `<div class="list-left"><div class="dot ${o.type}"></div></div>
                          <div class="list-mid"><div class="title">${o.name || o.id}</div>
                          <div class="meta">${o.type} ‚Ä¢ id:${o.id}</div></div>
                          <div class="list-right"><div class="pos">x:${(o.x||0).toFixed(0)}</div></div>`;
          el.addEventListener('click', () => selectObject(o));
          objectsList.appendChild(el);
        }
      }

      function renderAlerts() {
        alertsTableBody.innerHTML = '';
        for (let i = 0; i < Math.min(alerts.length, 50); i++) {
          const a = alerts[i];
          const tr = document.createElement('tr');
          const time = new Date(a._ts || Date.now()).toLocaleTimeString();
          const pair = `${a.sat_id || a.object1_id} ‚Üî ${a.debris_id || a.object2_id}`;
          tr.innerHTML = `<td>${time}</td>
                          <td>${pair}</td>
                          <td>${(a.distance||a.dist||0).toFixed(1)}</td>
                          <td>${(a.speed||0).toFixed(2)}</td>
                          <td><span class="risk ${(a.risk_class||'LOW').toLowerCase()}">${a.risk_class||'LOW'}</span></td>`;
          alertsTableBody.appendChild(tr);
        }
      }

      function selectObject(o) {
        selectedId = o.type + "-" + o.id;
        // Show details
        detailsEl.innerHTML = `
          <div class="sel-name">${o.name || o.id}</div>
          <div class="sel-meta">Type: ${o.type}</div>
          <div>ECI X: ${(o.x||0).toFixed(3)} km</div>
          <div>ECI Y: ${(o.y||0).toFixed(3)} km</div>
          <div>ECI Z: ${(o.z||0).toFixed(3)} km</div>
          <div>VX: ${(o.vx||0).toFixed(3)} km/s</div>
          <div>VY: ${(o.vy||0).toFixed(3)} km/s</div>
          <div>VZ: ${(o.vz||0).toFixed(3)} km/s</div>
        `;
        // try to center/flash object in the Three.js scene by storing a global hint
        if (window.focusObjectInThree) window.focusObjectInThree(o);
        document.querySelectorAll('.list-item').forEach(el => el.classList.toggle('selected', el.dataset.id === selectedId));
      }

      // UI events
      filterType.addEventListener('change', renderObjectsList);
      searchInput.addEventListener('input', renderObjectsList);
      btnPause.addEventListener('click', () => {
        paused = !paused;
        btnPause.textContent = paused ? 'Resume Stream' : 'Pause Stream';
      });
      btnCenter.addEventListener('click', () => {
        if (window.centerCamera) window.centerCamera();
      });

      // Start WS
      connectWS();
    })();
  </script>

</body>
</html>
